<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title id="page-title">WIZs | Anonymous Chat</title>
    <link id="favicon" rel="icon" href="https://cdn-icons-png.flaticon.com/512/3659/3659744.png">
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --blue: #00f2fe; --mint: #7bed9f; --red: #ff4d4d; --yellow: #f1c40f; --gray: #333; }
        body { background: var(--bg); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 180px; overflow-x: hidden; }

        /* --- STATUS BAR --- */
        #status-bar { position: fixed; top: 0; left: 0; width: 100%; background: #111; padding: 10px 20px; z-index: 999; border-bottom: 1px solid #222; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; box-sizing: border-box; }
        .bar-left { display: flex; align-items: center; gap: 15px; }
        .bar-center { font-weight: 900; font-size: 1.2rem; letter-spacing: 2px; color: var(--blue); text-shadow: 0 0 10px rgba(0,242,254,0.3); text-align: center; }
        .bar-right { display: flex; align-items: center; gap: 12px; justify-content: flex-end; }
        .gear-btn, .star-btn { cursor: pointer; color: #888; transition: 0.2s; font-size: 16px; }
        .report-link { color: #555; text-decoration: none; font-size: 10px; border: 1px solid #222; padding: 2px 6px; border-radius: 4px; white-space: nowrap; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: #111; padding: 25px; border-radius: 20px; max-width: 450px; width: 90%; text-align: center; border: 1px solid var(--gray); }
        .modal-btn { background: var(--blue); color: black; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; margin-top: 15px; }

        /* --- GIF PICKER --- */
        #gif-results { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; margin-top: 15px; padding: 5px; }
        .tenor-gif { width: 100%; border-radius: 8px; cursor: pointer; background: #222; transition: 0.2s; }

        /* --- FEED & MESSAGES --- */
        #feed { max-width: 600px; margin: 80px auto 0; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { background: var(--card); padding: 15px; border-radius: 12px; border-left: 4px solid var(--u-color); position: relative; animation: slideIn 0.2s ease-out; cursor: pointer; }
        
        .vid-container { position: relative; width: 100%; margin-top: 10px; border-radius: 8px; overflow: hidden; background: #000; }
        .mute-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; z-index: 10; font-size: 12px; visibility: hidden; }
        .unblurred + .mute-btn { visibility: visible; }
        .media-msg { width: 100%; border-radius: 8px; filter: blur(45px); transition: filter 0.4s ease; display: block; background: #000; }
        .unblurred { filter: blur(0) !important; }

        /* Notifications & Replies */
        .was-replied-to { border: 1px solid var(--mint) !important; box-shadow: 0 0 10px rgba(123, 237, 159, 0.1); }
        .reply-notif-tag { color: var(--mint); font-size: 10px; font-weight: bold; margin-top: 8px; display: block; border-top: 1px solid #222; padding-top: 5px; }
        .is-reply-to-me { background: #1a1f24; border-right: 3px solid var(--blue); }

        /* --- INPUT --- */
        .input-wrap { position: fixed; bottom: 0; width: 100%; background: rgba(10,10,10,0.98); padding: 15px 20px; border-top: 1px solid #222; backdrop-filter: blur(15px); }
        #reply-preview { display: none; background: #222; padding: 8px 15px; border-radius: 8px 8px 0 0; font-size: 12px; border-left: 3px solid var(--blue); justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .input-controls { display: flex; gap: 12px; align-items: center; }
        input[type="text"] { flex-grow: 1; background: #1a1a1a; border: 1px solid #333; padding: 12px; color: white; border-radius: 8px; outline: none; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .user-item { padding: 8px; border-bottom: 1px solid #222; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px; }
        #userListContainer { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; max-height: 100px; overflow-y: auto; margin: 10px 0; padding: 5px; text-align: left; }
    </style>
</head>
<body>

<div id="welcomeModal" class="modal" style="display: flex;">
    <div class="modal-content">
        <h2 style="color:var(--blue)">Welcome to WIZs</h2>
        <p>Anonymous chatting. No logs. No trace.<br>Automatic wipe every 15 minutes.</p>
        <button class="modal-btn" onclick="initAudio(); closeModal('welcomeModal')">Begin Chatting</button>
    </div>
</div>

<div id="gifModal" class="modal">
    <div class="modal-content">
        <h3>Tenor GIF Search</h3>
        <input type="text" id="gifSearchInput" placeholder="Search for GIFs..." style="width:90%; padding:10px; background:#222; border:1px solid #444; color:white; border-radius:8px;">
        <div id="gif-results"></div>
        <button class="modal-btn" style="background:#333; color:white;" onclick="closeModal('gifModal')">Close</button>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h3>User Settings</h3>
        <input type="text" id="newNick" placeholder="Change nickname..." maxlength="15" style="width:90%; padding:10px; background:#222; border:1px solid #444; color:white; border-radius:8px;">
        <p style="font-size:12px; margin-top:10px;">Name Color:</p>
        <div id="colorPicker" style="display:grid; grid-template-columns: repeat(5, 1fr); gap: 5px;"></div>
        <p style="font-size:12px; margin-top:15px;">Block Users:</p>
        <div id="userListContainer"></div>
        <button class="modal-btn" style="background:var(--red); color:white;" onclick="unblockAll()">Unblock All</button>
        <button class="modal-btn" onclick="saveSettings()">Save & Close</button>
    </div>
</div>

<div id="status-bar">
    <div class="bar-left"><i class="fa-solid fa-gear gear-btn" onclick="openSettings()"></i> <span id="reset-timer" style="font-size: 11px; margin-left: 10px;">15:00</span></div>
    <div class="bar-center">WIZs</div>
    <div class="bar-right">
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSeChvOFtxPM9caxUlsDXyzw903xFSm0WmvQ9yeNEswdFuoBpw/viewform?usp=header" target="_blank" class="report-link">Report issues</a>
        <span id="count-display" style="font-size:10px; color:var(--blue);">0 Online</span>
    </div>
</div>

<div id="feed"></div>

<div class="input-wrap">
    <div id="reply-preview"><span id="reply-text" style="color:var(--blue); font-size:11px;">Replying...</span><span id="cancel-reply" style="cursor:pointer; color:var(--red); margin-left:10px;">Ã—</span></div>
    <div class="input-controls">
        <label style="cursor:pointer; color:var(--blue); font-size:20px;"><i class="fa-solid fa-paperclip"></i><input type="file" id="mediaInput" hidden accept="image/*,video/*"></label>
        <span onclick="openGIFs()" style="cursor:pointer; color:var(--mint); font-weight:bold; font-size:14px;">GIF</span>
        <input type="text" id="wizsInput" placeholder="Message, Tenor, or YouTube link..." autocomplete="off">
    </div>
</div>

<script>
    const socket = io();
    let myName = "Wiz-" + Math.floor(Math.random()*999);
    let myColor = "#00f2fe";
    let myId = "";
    let selectedReply = null; 
    let blockedIds = new Set();
    let discoveredUsers = {}; 
    let audioCtx = null;

    // --- NOTIFICATION ENGINE ---
    function initAudio() { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    
    function playBeep() {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine"; osc.frequency.setValueAtTime(550, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }

    function drawNotificationBadge() {
        const favicon = document.getElementById('favicon');
        const canvas = document.createElement('canvas');
        canvas.width = 32; canvas.height = 32;
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = "https://cdn-icons-png.flaticon.com/512/3659/3659744.png";
        img.onload = () => {
            ctx.drawImage(img, 0, 0, 32, 32);
            ctx.beginPath();
            ctx.arc(24, 8, 8, 0, 2 * Math.PI);
            ctx.fillStyle = "#ff4d4d";
            ctx.fill();
            ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
            favicon.href = canvas.toDataURL('image/png');
            document.title = "( ! ) WIZs | New Reply";
        };
    }

    window.onfocus = () => {
        document.getElementById('favicon').href = "https://cdn-icons-png.flaticon.com/512/3659/3659744.png";
        document.title = "WIZs | Anonymous Chat";
    };

    // --- TENOR GIF SYSTEM ---
    async function fetchGIFs(q) {
        const url = `https://tenor.googleapis.com/v2/search?q=${q}&key=LIVNE7WABNEL&limit=12&client_key=wizs_v3`;
        try {
            const res = await fetch(url); const data = await res.json();
            const container = document.getElementById('gif-results'); container.innerHTML = '';
            data.results.forEach(gif => {
                const img = document.createElement('img'); img.src = gif.media_formats.tinygif.url; img.className = 'tenor-gif';
                img.onclick = () => {
                    socket.emit('send-msg', { name: myName, color: myColor, text: "[GIF]", image: gif.media_formats.gif.url, msgId: "g-"+Date.now(), replyTo: selectedReply });
                    closeModal('gifModal');
                };
                container.appendChild(img);
            });
        } catch (e) { console.error(e); }
    }
    function openGIFs() { document.getElementById('gifModal').style.display = 'flex'; fetchGIFs("trending"); }
    document.getElementById('gifSearchInput').oninput = (e) => fetchGIFs(e.target.value || "trending");

    // --- MULTIMEDIA (Blur/Audio Toggle) ---
    window.toggleMedia = (el) => {
        const isBlurred = !el.classList.contains('unblurred');
        if (isBlurred) {
            el.classList.add('unblurred');
            if (el.tagName === 'VIDEO') el.play();
        } else {
            el.classList.remove('unblurred');
            if (el.tagName === 'VIDEO') { el.pause(); el.muted = true; }
        }
    };
    window.toggleMute = (btn, vidId) => {
        const v = document.getElementById(vidId);
        v.muted = !v.muted;
        btn.innerHTML = v.muted ? '<i class="fa-solid fa-volume-xmark"></i>' : '<i class="fa-solid fa-volume-high"></i>';
    };

    // --- MESSAGE RECEIVER & RESOLVERS ---
    socket.on('assign-id', id => myId = id);
    socket.on('user-count', c => document.getElementById('count-display').innerText = `${c} Online`);
    socket.on('timer-update', s => {
        const m = Math.floor(s/60); const sec = s%60;
        document.getElementById('reset-timer').innerText = `${m}:${sec<10?'0':''}${sec}`;
    });
    socket.on('room-reset', () => location.reload());

    socket.on('receive-msg', data => {
        if (data.userId !== myId && !discoveredUsers[data.userId]) discoveredUsers[data.userId] = data.name;
        if (blockedIds.has(data.userId)) return;

        const div = document.createElement('div');
        div.className = 'msg'; div.id = data.msgId; div.style.setProperty('--u-color', data.color);
        
        // Tab Notification Trigger
        if (data.replyTo && data.replyTo.name === myName) {
            div.classList.add('is-reply-to-me');
            if (document.hidden || !document.hasFocus()) { playBeep(); drawNotificationBadge(); }
        }

        let mediaHtml = '';
        // Direct Uploads
        if (data.image) mediaHtml = `<img src="${data.image}" class="media-msg" onclick="event.stopPropagation(); toggleMedia(this)">`;
        if (data.video) {
            const vidId = "v-" + data.msgId;
            mediaHtml = `<div class="vid-container">
                <video id="${vidId}" src="${data.video}" class="media-msg" onclick="event.stopPropagation(); toggleMedia(this)" loop muted></video>
                <button class="mute-btn" onclick="event.stopPropagation(); toggleMute(this, '${vidId}')"><i class="fa-solid fa-volume-xmark"></i></button>
            </div>`;
        }

        // YouTube Resolver
        if (data.text.includes('youtube.com') || data.text.includes('youtu.be')) {
            const vid = data.text.split('v=')[1]?.split('&')[0] || data.text.split('.be/')[1];
            if (vid) mediaHtml += `<iframe width="100%" height="250" src="https://www.youtube.com/embed/${vid}" frameborder="0" style="margin-top:10px; border-radius:8px;" allowfullscreen></iframe>`;
        }

        // --- NEW TENOR RESOLVER ---
        if (data.text.includes('tenor.com')) {
            const tenorMatch = data.text.match(/tenor\.com\/(?:view\/.*-)?(?:.*-)?(\d+)/) || data.text.match(/tenor\.com\/([\w\d]+)\.gif/);
            if (tenorMatch) {
                const tenorId = tenorMatch[1];
                mediaHtml += `<img src="https://media.tenor.com/${tenorId}/tenor.gif" class="media-msg" onclick="event.stopPropagation(); toggleMedia(this)">`;
            }
        }

        let replyHeader = data.replyTo ? `<div style="font-size:11px; color:#666; font-style:italic;">Replying to @${data.replyTo.name}</div>` : '';
        if (data.replyTo) {
            const orig = document.getElementById(data.replyTo.msgId);
            if (orig && !orig.querySelector('.reply-notif-tag')) {
                const t = document.createElement('span'); t.className = 'reply-notif-tag';
                t.innerText = `ðŸ’¬ ${data.name} replied.`; orig.appendChild(t);
            }
        }

        div.innerHTML = `${replyHeader}<div style="font-weight:bold; color:${data.color}">${data.name}</div><div>${data.text}</div>${mediaHtml}`;
        div.onclick = () => {
            selectedReply = { name: data.name, msgId: data.msgId };
            document.getElementById('reply-preview').style.display = 'flex';
            document.getElementById('reply-text').innerText = `Replying to @${data.name}`;
            document.getElementById('wizsInput').focus();
        };

        document.getElementById('feed').appendChild(div);
        window.scrollTo(0, document.body.scrollHeight);
    });

    // --- INPUT ACTIONS ---
    document.getElementById('wizsInput').onkeydown = e => {
        if (e.key === 'Enter' && e.target.value.trim()) {
            const id = "m-" + Date.now();
            socket.emit('send-msg', { name: myName, color: myColor, text: e.target.value, replyTo: selectedReply, msgId: id });
            e.target.value = ''; selectedReply = null; document.getElementById('reply-preview').style.display = 'none';
        }
    };

    document.getElementById('mediaInput').onchange = e => {
        const file = e.target.files[0]; const reader = new FileReader();
        reader.onload = () => {
            const type = file.type.startsWith('video') ? 'video' : 'image';
            socket.emit('send-msg', { name: myName, color: myColor, text: `[Shared ${type}]`, [type]: reader.result, msgId: "u-"+Date.now(), replyTo: selectedReply });
        };
        reader.readAsDataURL(file);
    };

    // --- SETTINGS LOGIC ---
    const colors = ['#00f2fe', '#4facfe', '#2ecc71', '#e74c3c', '#f1c40f', '#9b59b6', '#ff9f43', '#1abc9c', '#3498db', '#ffffff'];
    colors.forEach(c => {
        const d = document.createElement('div'); d.style.background = c; d.style.height = '20px'; d.style.borderRadius = '4px'; d.style.cursor = 'pointer';
        d.onclick = () => myColor = c; document.getElementById('colorPicker').appendChild(d);
    });
    function openSettings() {
        const c = document.getElementById('userListContainer'); c.innerHTML = '';
        Object.keys(discoveredUsers).forEach(id => {
            const i = document.createElement('div'); i.className = 'user-item';
            i.innerHTML = `<span>${discoveredUsers[id]}</span> <span style="color:var(--red)">${blockedIds.has(id)?'Blocked':'Block'}</span>`;
            i.onclick = () => { blockedIds.has(id)?blockedIds.delete(id):blockedIds.add(id); openSettings(); };
            c.appendChild(i);
        });
        document.getElementById('settingsModal').style.display = 'flex';
    }
    function saveSettings() { const n = document.getElementById('newNick').value; if(n) myName = n; closeModal('settingsModal'); }
    function unblockAll() { blockedIds.clear(); openSettings(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    document.getElementById('cancel-reply').onclick = () => { selectedReply = null; document.getElementById('reply-preview').style.display = 'none'; };
</script>
</body>
</html>
