<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title id="page-title">WIZs | Anonymous Chat</title>
    <link id="favicon" rel="icon" href="https://cdn-icons-png.flaticon.com/512/3659/3659744.png">
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CORE VARIABLES (Controlled by JS Theme Engine) */
        :root { 
            --bg: #0a0a0a; 
            --card: #161616; 
            --accent: #00f2fe; 
            --text-main: #e0e0e0;
            --mint: #7bed9f; 
            --red: #ff4d4d; 
            --yellow: #f1c40f; 
        }

        body { background: var(--bg); color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 180px; overflow-x: hidden; transition: background 0.5s ease; }

        /* --- ASTROLIGHT SPECIAL FX --- */
        @keyframes drift { 0% { background-position: 0% 0%; } 100% { background-position: 100% 100%; } }
        .astrolight-fx {
            background-image: radial-gradient(white 1px, transparent 1px), radial-gradient(rgba(255,255,255,0.5) 1px, transparent 1px);
            background-size: 50px 50px, 30px 30px;
            background-position: 0 0, 15px 15px;
            animation: drift 60s linear infinite;
        }

        /* --- STATUS BAR --- */
        #status-bar { position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); padding: 10px 20px; z-index: 2000; border-bottom: 1px solid #333; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 15px; }
        .bar-left { display: flex; align-items: center; gap: 15px; }
        .bar-center { font-weight: 900; font-size: 1.2rem; letter-spacing: 2px; color: var(--accent); text-shadow: 0 0 10px rgba(255,255,255,0.1); text-align: center; }
        .bar-right { display: flex; align-items: center; gap: 12px; justify-content: flex-end; }
        
        .icon-btn { cursor: pointer; color: #888; transition: 0.2s; font-size: 16px; }
        .icon-btn:hover { color: var(--accent); transform: scale(1.1); }

        /* --- MEDIA SIDEBAR --- */
        #media-sidebar { position: fixed; top: 50px; left: 0; width: 320px; height: calc(100% - 50px); background: #0f0f0f; border-right: 1px solid #333; z-index: 1999; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 15px; overflow-y: auto; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        #media-sidebar.active { transform: translateX(0); }
        .media-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .sidebar-item { width: 100%; border-radius: 6px; border: 1px solid #333; background: #000; aspect-ratio: 1/1; object-fit: cover; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* --- OWNER RAINBOW EFFECTS --- */
        @keyframes rainbowBorder { 
            0% { border-color: #ff0000; box-shadow: 0 0 8px #ff0000; } 
            20% { border-color: #ffff00; box-shadow: 0 0 8px #ffff00; }
            40% { border-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
            60% { border-color: #00ffff; box-shadow: 0 0 8px #00ffff; }
            80% { border-color: #ff00ff; box-shadow: 0 0 8px #ff00ff; }
            100% { border-color: #ff0000; box-shadow: 0 0 8px #ff0000; } 
        }
        @keyframes textShine { to { background-position: 200% center; } }

        .rainbow-name { background: linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8f00ff, #ff0000); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: textShine 3s linear infinite; font-weight: 900; }
        .rainbow-input-local { animation: rainbowBorder 4s linear infinite !important; border-width: 2px !important; border-style: solid !important; }
        .rainbow-msg-box { animation: rainbowBorder 4s linear infinite; border-width: 2px !important; border-style: solid !important; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card); padding: 25px; border-radius: 20px; max-width: 450px; width: 90%; text-align: center; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-btn { background: var(--accent); color: black; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; margin-top: 15px; }

        /* DROPDOWNS */
        select, input[type="text"] { width: 95%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; border-radius: 8px; outline: none; margin-bottom: 10px; font-family: inherit; }
        select option { background: #111; color: white; }

        /* --- GIF PICKER --- */
        #gif-results { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; margin-top: 15px; padding: 5px; }
        .tenor-gif { width: 100%; border-radius: 8px; cursor: pointer; background: #222; transition: 0.2s; }

        /* --- FEED --- */
        #feed { max-width: 600px; margin: 80px auto 0; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { background: var(--card); color: var(--text-main); padding: 15px; border-radius: 12px; border-left: 4px solid var(--u-color); position: relative; animation: slideIn 0.2s ease-out; cursor: pointer; border: 1px solid transparent; transition: background 0.3s; }
        
        .vid-container { position: relative; width: 100%; margin-top: 10px; border-radius: 8px; overflow: hidden; background: #000; }
        .media-msg { width: 100%; border-radius: 8px; filter: blur(45px); transition: filter 0.4s ease; display: block; background: #000; }
        .unblurred { filter: blur(0) !important; }

        /* --- INPUT --- */
        .input-wrap { position: fixed; bottom: 0; width: 100%; background: var(--card); padding: 15px 20px; border-top: 1px solid #333; z-index: 2000; transition: background 0.5s ease; }
        #reply-preview { display: none; background: rgba(0,0,0,0.2); padding: 8px 15px; border-radius: 8px 8px 0 0; font-size: 12px; border-left: 3px solid var(--accent); justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .input-controls { display: flex; gap: 12px; align-items: center; }
        #wizsInput { flex-grow: 1; margin-bottom: 0; border: 1px solid #444; background: rgba(0,0,0,0.3); }

        @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .user-item { padding: 8px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px; color: #ccc; }
        #userListContainer { background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 8px; max-height: 100px; overflow-y: auto; margin: 10px 0; padding: 5px; text-align: left; }
        
        .admin-toggle { display: none; margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
        .admin-toggle label { display: block; font-size: 12px; margin-bottom: 5px; cursor: pointer; color: var(--yellow); }
    </style>
</head>
<body id="mainBody">

<div id="media-sidebar">
    <div class="sidebar-header">
        <span style="font-weight:bold; color:var(--accent)">Media Gallery</span>
        <span onclick="toggleSidebar()" style="cursor:pointer; color:#666">✕</span>
    </div>
    <div class="media-grid" id="sidebar-content"></div>
</div>

<div id="changelogModal" class="modal">
    <div class="modal-content">
        <h3><i class="fa-solid fa-terminal" style="color:var(--mint)"></i> System Log</h3>
        <p style="color:var(--accent); font-weight:bold; font-size:14px;">You are LIVE on Version 3.3.1</p>
        <div style="text-align: left; font-family: 'Consolas', monospace; font-size: 13px; color: #ccc; line-height: 1.5; margin: 15px 0; background: #000; padding: 15px; border-radius: 8px; border: 1px solid #333;">
            <span style="color:var(--mint); font-weight:bold;">V.3.3.1 Update</span><br>
            - Added THEME ENGINE (Settings > BG & Text Color).<br>
            - Compact Settings Menu.<br>
            - 7 New Presets (Astrolight, FlameLight, Sandy Oasis, etc).<br>
            <span style="color:var(--yellow)">* Owner Rainbow Effects fully integrated.</span>
        </div>
        <button class="modal-btn" onclick="closeModal('changelogModal')">close</button>
    </div>
</div>

<div id="welcomeModal" class="modal" style="display: flex;">
    <div class="modal-content">
        <h2 style="color:var(--accent)">Welcome to WIZs</h2>
        <p>Anonymous chatting. No logs. No trace.<br>Automatic wipe every 15 minutes.</p>
        <button class="modal-btn" onclick="initAudio(); closeModal('welcomeModal')">Begin Chatting</button>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">User Settings</h3>
        
        <label style="display:block; text-align:left; font-size:11px; color:#888; margin-bottom:5px;">Nickname</label>
        <input type="text" id="newNick" placeholder="Change nickname..." maxlength="15">
        
        <label style="display:block; text-align:left; font-size:11px; color:#888; margin-bottom:5px;">Name Color</label>
        <select id="colorSelect">
            <option value="#00f2fe" style="color:#00f2fe">Cyan (Default)</option>
            <option value="#4facfe" style="color:#4facfe">Sky Blue</option>
            <option value="#2ecc71" style="color:#2ecc71">Emerald Green</option>
            <option value="#e74c3c" style="color:#e74c3c">Crimson Red</option>
            <option value="#f1c40f" style="color:#f1c40f">Sunflower Yellow</option>
            <option value="#9b59b6" style="color:#9b59b6">Amethyst Purple</option>
            <option value="#ff9f43" style="color:#ff9f43">Orange Peel</option>
            <option value="#ffffff" style="color:#ffffff">Pure White</option>
        </select>

        <label style="display:block; text-align:left; font-size:11px; color:#888; margin-bottom:5px;">BG & Text Color (Theme)</label>
        <select id="themeSelect" onchange="applyTheme(this.value)">
            <option value="default">Default (Cyan/Dark)</option>
            <option value="seashine">Seashine (Teal/Deep Blue)</option>
            <option value="grassy">Grassy Plains (Green/Mint)</option>
            <option value="sandy">Sandy Oasis (Orange/Beige)</option>
            <option value="flame">FlameLight (Maroon/Red)</option>
            <option value="candy">CandyPink (Pink/Hot Pink)</option>
            <option value="astrolight">✨ Astrolight (Space + Stars)</option>
        </select>

        <label style="display:block; text-align:left; font-size:11px; color:#888; margin-bottom:5px;">Block Users</label>
        <div id="userListContainer"></div>
        
        <div id="adminControls" class="admin-toggle">
            <p style="color:var(--yellow); font-weight:bold; margin:5px 0;">Owner Controls</p>
            <label><input type="checkbox" id="toggleRainbowName" checked onchange="toggleAdminFx()"> Rainbow Name Text</label>
            <label><input type="checkbox" id="toggleRainbowBox" checked onchange="toggleAdminFx()"> Rainbow Message Box</label>
            <label><input type="checkbox" id="toggleRainbowInput" checked onchange="toggleAdminFx()"> Rainbow Input Field</label>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:15px;">
            <button class="modal-btn" style="background:var(--red); color:white; font-size:12px; padding:8px 15px;" onclick="unblockAll()">Unblock All</button>
            <button class="modal-btn" style="font-size:12px; padding:8px 15px;" onclick="saveSettings()">Save & Close</button>
        </div>
    </div>
</div>

<div id="gifModal" class="modal">
    <div class="modal-content">
        <h3>Tenor GIF Search</h3>
        <input type="text" id="gifSearchInput" placeholder="Search for GIFs...">
        <div id="gif-results"></div>
        <button class="modal-btn" style="background:#333; color:white;" onclick="closeModal('gifModal')">Close</button>
    </div>
</div>

<div id="status-bar">
    <div class="bar-left">
        <i class="fa-solid fa-gear icon-btn" onclick="openSettings()" title="Settings"></i>
        <i class="fa-solid fa-photo-film icon-btn" onclick="toggleSidebar()" title="Media Gallery"></i>
        <i class="fa-solid fa-terminal icon-btn" onclick="document.getElementById('changelogModal').style.display='flex'" title="Changelogs"></i>
        <span id="reset-timer" style="font-size: 11px; margin-left: 5px; color:#555;">15:00</span>
    </div>
    <div class="bar-center">WIZs</div>
    <div class="bar-right">
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSeChvOFtxPM9caxUlsDXyzw903xFSm0WmvQ9yeNEswdFuoBpw/viewform?usp=header" target="_blank" class="report-link">Report issues</a>
        <div style="display:flex; align-items:center; gap:5px;">
            <span id="connection-dot" class="status-dot status-orange"></span>
            <span id="count-display" style="font-size:10px; color:var(--accent);">0 Online</span>
        </div>
    </div>
</div>

<div id="feed"></div>

<div class="input-wrap">
    <div id="reply-preview"><span id="reply-text" style="color:var(--accent); font-size:11px;">Replying...</span><span id="cancel-reply" style="cursor:pointer; color:var(--red); margin-left:10px;">×</span></div>
    <div class="input-controls">
        <label style="cursor:pointer; color:var(--accent); font-size:20px;"><i class="fa-solid fa-paperclip"></i><input type="file" id="mediaInput" hidden accept="image/*,video/*"></label>
        <span onclick="openGIFs()" style="cursor:pointer; color:var(--mint); font-weight:bold; font-size:14px;">GIF</span>
        <input type="text" id="wizsInput" placeholder="Message, Tenor, or YouTube link..." autocomplete="off">
    </div>
</div>

<script>
    const socket = io();
    let myName = "Wiz-" + Math.floor(Math.random()*999);
    let myColor = "#00f2fe";
    let myId = "";
    let selectedReply = null; 
    let blockedIds = new Set();
    let discoveredUsers = {}; 
    let audioCtx = null;
    let isAdmin = false;
    
    // --- THEME ENGINE ---
    const themes = {
        default: { bg: "#0a0a0a", card: "#161616", accent: "#00f2fe" },
        seashine: { bg: "#001f24", card: "#00333b", accent: "#00e5ff" },
        grassy: { bg: "#0e2411", card: "#18361b", accent: "#7bed9f" },
        sandy: { bg: "#2e2516", card: "#453823", accent: "#ff9f43" },
        flame: { bg: "#2e0b0b", card: "#4d1212", accent: "#ff4757" },
        candy: { bg: "#2e0b1f", card: "#4d1233", accent: "#ff6b81" },
        astrolight: { bg: "#150a26", card: "#241240", accent: "#dfa8ff" }
    };

    function applyTheme(themeName) {
        const t = themes[themeName] || themes.default;
        const r = document.documentElement.style;
        r.setProperty('--bg', t.bg);
        r.setProperty('--card', t.card);
        r.setProperty('--accent', t.accent);
        document.getElementById('mainBody').className = (themeName === 'astrolight') ? 'astrolight-fx' : '';
    }

    // --- AUDIO & SOCKET SETUP ---
    const dot = document.getElementById('connection-dot');
    socket.on('connect', () => { dot.className = 'status-dot status-green'; dot.title = "Connected"; });
    socket.on('disconnect', () => { dot.className = 'status-dot status-red'; dot.title = "Disconnected"; });
    function initAudio() { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playBeep() {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = "sine"; osc.frequency.setValueAtTime(550, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }
    
    // --- MESSAGING ---
    function sendMsg(text, mediaData = null, mediaType = null) {
        const payload = { 
            name: myName, color: myColor, text: text, replyTo: selectedReply, 
            msgId: (mediaType ? "u-" : "m-") + Date.now(),
            isRainbowName: (isAdmin && document.getElementById('toggleRainbowName').checked),
            isRainbowBox: (isAdmin && document.getElementById('toggleRainbowBox').checked) 
        };
        if (mediaType && mediaData) payload[mediaType] = mediaData;
        socket.emit('send-msg', payload);
        document.getElementById('wizsInput').value = ''; 
        selectedReply = null; 
        document.getElementById('reply-preview').style.display = 'none';
    }

    socket.on('receive-msg', data => {
        if (blockedIds.has(data.userId)) return;
        if (data.userId !== myId && !discoveredUsers[data.userId]) discoveredUsers[data.userId] = data.name;

        const div = document.createElement('div'); div.className = 'msg'; div.id = data.msgId; div.style.setProperty('--u-color', data.color);
        if (data.replyTo && data.replyTo.name === myName) { div.classList.add('is-reply-to-me'); if(document.hidden) playBeep(); }

        let mediaHtml = '';
        if (data.image) mediaHtml = `<img src="${data.image}" class="media-msg" onclick="event.stopPropagation(); toggleMedia(this)">`;
        if (data.video) {
            const vidId = "v-" + data.msgId;
            mediaHtml = `<div class="vid-container"><video id="${vidId}" src="${data.video}" class="media-msg" onclick="event.stopPropagation(); toggleMedia(this)" loop muted></video></div>`;
        }
        if (data.text.includes('youtube.com') || data.text.includes('youtu.be')) {
            const vid = data.text.split('v=')[1]?.split('&')[0] || data.text.split('.be/')[1];
            if (vid) { mediaHtml += `<iframe width="100%" height="250" src="https://www.youtube.com/embed/${vid}" frameborder="0" style="margin-top:10px; border-radius:8px;" allowfullscreen></iframe>`; }
        }

        if (data.image || data.video) {
             const i = document.createElement('div'); 
             i.innerHTML = `<img src="${data.image || 'https://via.placeholder.com/100?text=Video'}" class="sidebar-item">`; 
             document.getElementById('sidebar-content').prepend(i); 
        }

        let nameClass = (data.name === "WIZs Owner" || data.isRainbowName) ? "rainbow-name" : "";
        if (data.isRainbowBox) div.classList.add('rainbow-msg-box');
        let replyHeader = data.replyTo ? `<div style="font-size:11px; opacity:0.7; margin-bottom:5px;">Replying to @${data.replyTo.name}</div>` : '';
        div.innerHTML = `${replyHeader}<div class="${nameClass}" style="font-weight:bold; color:${data.color}">${data.name}</div><div style="margin-top:5px;">${data.text}</div>${mediaHtml}`;
        div.onclick = () => { selectedReply = { name: data.name, msgId: data.msgId }; document.getElementById('reply-preview').style.display = 'flex'; document.getElementById('reply-text').innerText = `Replying to @${data.name}`; document.getElementById('wizsInput').focus(); };
        document.getElementById('feed').appendChild(div); window.scrollTo(0, document.body.scrollHeight);
    });

    // --- SETTINGS & ADMIN ---
    function openSettings() {
        const c = document.getElementById('userListContainer'); c.innerHTML = '';
        Object.keys(discoveredUsers).forEach(id => { 
            const i = document.createElement('div'); i.className = 'user-item'; 
            i.innerHTML = `<span>${discoveredUsers[id]}</span> <span style="color:var(--red)">${blockedIds.has(id)?'Blocked':'Block'}</span>`; 
            i.onclick = () => { blockedIds.has(id)?blockedIds.delete(id):blockedIds.add(id); openSettings(); }; 
            c.appendChild(i); 
        });
        document.getElementById('adminControls').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('settingsModal').style.display = 'flex';
    }

    function saveSettings() {
        const n = document.getElementById('newNick').value;
        myColor = document.getElementById('colorSelect').value;
        if (n === 'Admin1') { isAdmin = true; myName = "WIZs Owner"; document.getElementById('newNick').value = ""; toggleAdminFx(); alert("Owner Verified."); } 
        else if (n && n !== "") { isAdmin = false; myName = n; }
        closeModal('settingsModal');
    }

    function toggleAdminFx() {
        if (!isAdmin) return;
        const input = document.getElementById('wizsInput');
        if (document.getElementById('toggleRainbowInput').checked) input.classList.add('rainbow-input-local');
        else input.classList.remove('rainbow-input-local');
    }

    // --- GIF SYSTEM RESTORED ---
    async function fetchGIFs(q) {
        const url = `https://tenor.googleapis.com/v2/search?q=${q}&key=LIVNE7WABNEL&limit=12&client_key=wizs_v3`;
        try {
            const res = await fetch(url); const data = await res.json();
            const container = document.getElementById('gif-results'); container.innerHTML = '';
            data.results.forEach(gif => {
                const img = document.createElement('img'); img.src = gif.media_formats.tinygif.url; img.className = 'tenor-gif';
                img.onclick = () => { sendMsg("[GIF]", gif.media_formats.gif.url, "image"); closeModal('gifModal'); };
                container.appendChild(img);
            });
        } catch (e) { console.error(e); }
    }
    function openGIFs() { document.getElementById('gifModal').style.display = 'flex'; fetchGIFs("trending"); }
    document.getElementById('gifSearchInput').oninput = (e) => fetchGIFs(e.target.value || "trending");

    // --- UPLOAD & UTILS ---
    document.getElementById('mediaInput').onchange = e => { const f = e.target.files[0]; const r = new FileReader(); r.onload = () => { const t = f.type.startsWith('video') ? 'video' : 'image'; sendMsg(`[Shared ${t}]`, r.result, t); }; r.readAsDataURL(f); };
    window.toggleMedia = (el) => { if(el.classList.contains('unblurred')) { el.classList.remove('unblurred'); if(el.tagName==='VIDEO') el.pause(); } else { el.classList.add('unblurred'); if(el.tagName==='VIDEO') el.play(); } };
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    document.getElementById('wizsInput').onkeydown = e => { if (e.key === 'Enter' && e.target.value.trim()) sendMsg(e.target.value); };
    document.getElementById('cancel-reply').onclick = () => { selectedReply = null; document.getElementById('reply-preview').style.display = 'none'; };
    function unblockAll() { blockedIds.clear(); openSettings(); }
    
    socket.on('user-count', c => document.getElementById('count-display').innerText = `${c} Online`);
    socket.on('assign-id', id => myId = id);
    socket.on('timer-update', s => document.getElementById('reset-timer').innerText = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`);
</script>
</body>
</html>
