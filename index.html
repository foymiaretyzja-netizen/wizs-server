<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIZs | Vivid</title>
    
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- DYNAMIC THEME VARIABLES (Default) --- */
        :root { 
            --c-dark: #050505;       /* Main Background */
            --c-panel: #2a0a55;      /* Panels/Modals/Sidebars */
            --c-accent: #00f2fe;     /* Borders/Icons/Text */
            --c-input: #1a0535;      /* Text Box Backgrounds */
            
            --text-color: #ffffff;
            --red: #ff0055; 
            --mint: #00ff9d;
        }

        * { box-sizing: border-box; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        
        body { 
            background: var(--c-dark); color: var(--text-color); 
            font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 180px; 
            overflow-x: hidden; opacity: 0; animation: fadeInBody 1s forwards; 
            overflow-y: scroll; 
        }

        @keyframes fadeInBody { to { opacity: 1; } }

        /* --- DESTRUCTION & NOTIFY ANIMATIONS --- */
        .destroy-anim {
            animation: crumble 2s forwards ease-in;
            pointer-events: none;
        }
        @keyframes crumble {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
            100% { transform: translate(random(100)px, 100vh) rotate(random(360)deg); opacity: 0; }
        }
        
        /* --- BACKGROUND SCENES --- */
        #bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; overflow: hidden; pointer-events: none;
        }

        /* SEA SHINE */
        .sea-gradient { background: linear-gradient(180deg, #006994 0%, #001f24 100%); width:100%; height:100%; position:absolute;}
        .wave-box { position: absolute; top: -50px; left: 0; width: 100%; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: waveRock 5s infinite ease-in-out; transform-origin: 50% 0; }
        .bubble { position: absolute; bottom: -20px; background: rgba(255,255,255,0.2); border-radius: 50%; box-shadow: 0 0 10px rgba(255,255,255,0.5); animation: riseUp 10s linear infinite; }
        @keyframes waveRock { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.2); } }
        @keyframes riseUp { 0% { transform: translateY(0) scale(1); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-110vh) scale(1.5); opacity: 0; } }

        /* SEAWEED FIELDS (Swaying Green) */
        .shallow-water-bg { background: linear-gradient(to bottom, #7be0ed 0%, #20b2aa 40%, #004d40 100%); width:100%; height:100%; position:absolute; }
        .strand { 
            position: absolute; bottom: -50px; width: 25px; 
            background: linear-gradient(to top, #004d40, #2e8b57);
            border-radius: 50% 50% 0 0; transform-origin: bottom center; opacity: 0.8;
            box-shadow: inset 5px 0 10px rgba(0,0,0,0.3);
            animation: swish 4s ease-in-out infinite alternate;
        }
        @keyframes swish { 0% { transform: rotate(-8deg) scaleY(1); } 100% { transform: rotate(12deg) scaleY(1.05); } }

        /* SANDY OASIS (Heat Distortion) */
        .desert-bg { background: linear-gradient(to bottom, #800000, #d35400, #e67e22); width:100%; height:100%; position:absolute; }
        .sun { position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%); width: 100px; height: 100px; background: linear-gradient(#f1c40f, #e67e22); border-radius: 50%; box-shadow: 0 0 40px #f39c12; }
        .dune { position: absolute; bottom: 0; width: 100%; height: 150px; background: #d35400; clip-path: polygon(0 100%, 100% 100%, 100% 40%, 75% 20%, 50% 60%, 25% 30%, 0 50%); }
        .heat-haze { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            backdrop-filter: blur(2px); 
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,200,100,0.05) 5px);
            animation: extremeHaze 0.8s infinite linear; opacity: 0.4; mix-blend-mode: overlay;
        }
        @keyframes extremeHaze { 
            0% { transform: translateY(0) scaleY(1); filter: hue-rotate(0deg); } 
            50% { transform: translateY(-3px) scaleY(1.02); } 
            100% { transform: translateY(-6px) scaleY(1); filter: hue-rotate(5deg); } 
        }

        /* FIRE */
        .fire-bg { background: #1a0505; width:100%; height:100%; position:absolute; box-shadow: inset 0 -100px 150px rgba(255,69,0,0.5); }
        .fireplace-glow { position: absolute; bottom: 0; width: 100%; height: 300px; background: radial-gradient(ellipse at bottom, rgba(255,69,0,0.4), transparent 70%); }
        .ember { position: absolute; bottom: 0; width: 4px; height: 4px; background: #ff4500; border-radius: 50%; animation: floatEmber linear infinite; box-shadow: 0 0 10px #ff6347; }
        @keyframes floatEmber { 0% { transform: translateY(0) translateX(0); opacity: 1; } 100% { transform: translateY(-80vh) translateX(20px); opacity: 0; } }

        /* ASTRO */
        .space-bg { background: radial-gradient(circle at bottom, #2b1055 0%, #000000 100%); width:100%; height:100%; position:absolute; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 2s infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; transform: scale(1.2); } }

        /* CANDY */
        .candy-bg { background: linear-gradient(#ffe6fa, #cceeff); width:100%; height:100%; position:absolute; }
        .falling-candy { position: absolute; font-size: 20px; top: -50px; animation: fallDown linear infinite; }
        @keyframes fallDown { to { transform: translateY(110vh) rotate(360deg); } }

        /* --- OVERLAYS --- */
        .overlay-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); text-align: center;
        }

        /* NOTIFY OVERLAY */
        #notify-overlay { background: rgba(0,0,0,0.85); border: 4px solid var(--c-accent); }
        .notify-box {
            background: var(--c-panel); border: 2px solid var(--c-accent);
            padding: 40px; border-radius: 20px; box-shadow: 0 0 50px var(--c-accent);
            max-width: 80%; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* --- UI ELEMENTS --- */
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--c-dark); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .intro-logo { font-size: 4rem; font-weight: 900; color: var(--c-accent); text-shadow: 0 0 20px var(--c-accent); transition: all 1s; }
        .intro-logo.minimize { transform: scale(0.3) translateY(-45vh); }
        
        #tutorial-card { display: none; background: var(--c-panel); width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; border: 2px solid var(--c-accent); text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .tut-step { display: none; }
        .tut-step.active { display: block; }
        
        #status-bar { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); padding: 0 20px; z-index: 2000; border-bottom: 2px solid var(--c-accent); display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; opacity: 0; box-shadow: 0 0 15px var(--c-panel); transition: border-color 0.4s; }
        .bar-center { font-weight: 900; font-size: 1.2rem; letter-spacing: 2px; color: var(--c-accent); text-shadow: 0 0 10px var(--c-accent); }
        .icon-btn { cursor: pointer; color: #888; font-size: 16px; transition: color 0.4s; }
        .icon-btn:hover { color: var(--c-accent); transform: scale(1.1); }

        /* SIDEBARS */
        #media-sidebar, #users-sidebar { position: fixed; top: 60px; width: 320px; height: calc(100% - 60px); background: var(--c-panel); border: 2px solid var(--c-accent); z-index: 1999; transform: translateX(100%); transition: transform 0.3s, background 0.4s, border-color 0.4s; overflow-y: auto; padding: 15px; }
        #media-sidebar { left: 0; transform: translateX(-100%); border-right: 2px solid var(--c-accent); border-left: none; }
        #users-sidebar { right: 0; }
        .active-side { transform: translateX(0) !important; }
        .sidebar-thumb { width:100%; aspect-ratio:16/9; object-fit:cover; border:1px solid var(--c-accent); margin-bottom:10px; cursor:pointer; }
        
        .user-row { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; font-size: 13px; cursor: pointer; color: var(--c-accent); }
        .user-row:hover { background: rgba(255,255,255,0.1); }
        .user-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }

        /* FEED & MESSAGES */
        #feed { max-width: 600px; margin: 80px auto 0; padding: 20px; display: flex; flex-direction: column; gap: 15px; position: relative; z-index: 1; }
        .msg { background: var(--c-panel); color: white; padding: 15px; border-radius: 12px; border: 1px solid var(--c-accent); border-left: 4px solid var(--u-color); position: relative; animation: slideUp 0.3s ease; word-wrap: break-word; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: background 0.4s, border-color 0.4s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* OWNER RAINBOWS */
        .rainbow-box { position: relative; overflow: hidden; border: none !important; }
        .rainbow-box::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(255,0,0,0.15), rgba(255,165,0,0.15), rgba(0,0,255,0.15)); background-size: 200% 200%; animation: rainbowShine 5s linear infinite; pointer-events: none; }
        @keyframes rainbowShine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .owner-name { background: linear-gradient(to right, red, orange, yellow, green, blue, violet); -webkit-background-clip: text; color: transparent; font-weight: 900; }

        /* OWNER INPUT RAINBOW (Special Request) */
        .owner-input-glow {
            background: linear-gradient(270deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #8b00ff) !important;
            background-size: 400% 400% !important;
            animation: rainbowFlow 6s ease infinite !important;
            color: white !important;
            border: 2px solid white !important;
            box-shadow: 0 0 20px rgba(255,255,255,0.8) !important;
        }
        @keyframes rainbowFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .media-msg { width: 100%; border-radius: 8px; filter: blur(45px); transition: filter 0.4s ease; max-height: 300px; object-fit: contain; background: #000; }
        .unblurred { filter: blur(0) !important; }

        /* INPUT AREA */
        .input-wrapper-outer { position: fixed; bottom: 0; width: 100%; z-index: 2000; display: flex; flex-direction: column; }
        #reply-bar { display: none; background: var(--c-panel); color: var(--c-accent); font-size: 12px; padding: 8px 20px; border-top: 1px solid var(--c-accent); justify-content: space-between; align-items: center; }
        .input-wrap { background: var(--c-dark); padding: 15px 20px; border-top: 2px solid var(--c-accent); transition: background 0.4s, border-color 0.4s; }
        .input-controls { display: flex; gap: 12px; align-items: center; }
        #wizsInput { flex-grow: 1; border: 2px solid var(--c-panel); background: var(--c-input); padding: 12px; border-radius: 8px; color: var(--c-accent); outline: none; font-weight: bold; transition: all 0.4s; }
        #wizsInput::placeholder { color: rgba(255,255,255,0.3); }
        #wizsInput:focus { border-color: var(--c-accent); box-shadow: 0 0 15px var(--c-panel); }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--c-panel); padding: 25px; border-radius: 20px; max-width: 450px; width: 90%; text-align: center; border: 2px solid var(--c-accent); max-height: 80vh; overflow-y: auto; box-shadow: 0 0 30px var(--c-panel); transition: background 0.4s, border-color 0.4s; }
        .modal-btn { background: var(--c-accent); color: var(--c-dark); border: none; padding: 10px 20px; border-radius: 25px; font-weight: 900; cursor: pointer; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; transition: background 0.4s; }
        .modal-btn:hover { filter: brightness(1.2); box-shadow: 0 0 15px var(--c-accent); }
        
        select, input[type="text"] { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--c-accent); color: white; border-radius: 8px; margin-bottom: 10px; }
    </style>
</head>
<body id="mainBody">

<div id="bg-container"></div>

<div id="destroyed-msg" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; color: var(--red); font-weight: 900; z-index: 10000; text-shadow: 0 0 20px var(--red);">REFRESH PLEASE.</div>

<div id="lockdown-overlay" class="overlay-screen" style="background:rgba(0,0,0,0.98);">
    <i class="fa-solid fa-lock" style="font-size:80px; color:var(--red); margin-bottom:20px;"></i>
    <h1 style="color:white; margin:0; text-transform: uppercase;">System Locked</h1>
</div>

<div id="kick-overlay" class="overlay-screen" style="background:black; z-index:10001;">
    <h1 style="color:var(--red);">YOU HAVE BEEN KICKED</h1>
    <p style="color:#666;">Connection Terminated.</p>
</div>

<div id="ban-overlay" class="overlay-screen" style="background:rgba(0,0,0,0.9);">
    <i class="fa-solid fa-ban" style="font-size:60px; color:var(--red); margin-bottom:20px;"></i>
    <h1 style="color:var(--red);">TEMPORARILY BANNED</h1>
    <p style="color:white;">View-Only mode for <span id="ban-timer-display" style="color:var(--c-accent); font-weight:bold;">0</span> minutes.</p>
</div>

<div id="notify-overlay" class="overlay-screen">
    <div class="notify-box">
        <h2 style="color:var(--red); margin:0; text-transform:uppercase; border-bottom:1px solid #555; padding-bottom:10px; margin-bottom:10px;">WIZs Auto Moderation</h2>
        <div style="font-size:18px; color:white; font-weight:bold; line-height:1.5;">
            <i class="fa-solid fa-triangle-exclamation" style="color:var(--red)"></i><br>
            <span id="notify-content">MESSAGE CONTENT</span>
        </div>
        <button class="modal-btn" onclick="document.getElementById('notify-overlay').style.display='none'">ACKNOWLEDGE</button>
    </div>
</div>

<div id="intro-overlay">
    <div class="intro-logo" id="introLogo">WIZs</div>
    <div id="tutorial-card">
        <div class="tut-step active" id="step1">
            <h2 style="color:var(--c-accent); margin-top:0;">Welcome</h2>
            <div style="background:#000; padding:10px; border-radius:8px; border:1px solid var(--c-accent); margin:15px 0;">
                <span style="color:var(--red); font-size:11px; font-weight:bold;">SYSTEM PURGE IN</span><br>
                <span id="tut-timer" style="font-size:20px; font-family:monospace; color:white">15:00</span>
            </div>
            <button class="modal-btn" onclick="nextStep(2)">Customize</button>
        </div>
        <div class="tut-step" id="step2">
            <h2 style="color:var(--mint);">Identify</h2>
            <input type="text" id="tut-nick" maxlength="20" placeholder="Username">
            <select id="tut-color">
                <option value="#00f2fe">Cyan</option> <option value="#e74c3c">Red</option> <option value="#2ecc71">Green</option>
                <option value="#f1c40f">Yellow</option> <option value="#ff6b81">Pink</option>
            </select>
            <select id="tut-theme" onchange="applyTheme(this.value)">
                <option value="default">Default Dark</option> 
                <option value="seashine">üåä Sea Shine</option> 
                <option value="seaweed">üåø Seaweed Fields</option>
                <option value="sandy">‚òÄÔ∏è Sandy Oasis</option> 
                <option value="flame">üî• Firelight</option> 
                <option value="candy">üç≠ Candyland</option>
                <option value="astrolight">üåå Astrolight</option>
            </select>
            <label style="color:white; font-size:12px;">
                 <input type="checkbox" id="tut-bg-fx" checked onchange="toggleEffects()"> Enable BG Effects?
            </label>
            <button class="modal-btn" onclick="syncSettings(); endTutorial()">Enter Chat</button>
        </div>
    </div>
</div>

<div id="verified-toast" style="display:none; position:fixed; top:70px; left:50%; transform:translateX(-50%); padding:10px 20px; background:rgba(0,255,0,0.2); border:1px solid #00ff00; color:#ccffcc; border-radius:25px; z-index:1900; align-items:center; gap:10px; backdrop-filter:blur(5px);">
    <i class="fa-solid fa-circle-check"></i> <span>ADMIN ACCESS GRANTED</span>
</div>

<div id="status-bar">
    <div class="bar-content" style="display:flex; align-items:center; gap:15px;">
        <i class="fa-solid fa-gear icon-btn" onclick="openMainSettings()"></i>
        <i class="fa-solid fa-photo-film icon-btn" onclick="document.getElementById('media-sidebar').classList.toggle('active-side')"></i>
        <span id="reset-timer-real" style="font-size:11px; color:#aaa;">15:00</span>
    </div>
    <div class="bar-center">WIZs</div>
    <div class="bar-content" style="justify-content:flex-end; display:flex; gap:10px;">
        <span id="count-display" style="font-size:10px; color:var(--c-accent);">0 Online</span>
        <i class="fa-solid fa-users icon-btn" onclick="document.getElementById('users-sidebar').classList.toggle('active-side')"></i>
    </div>
</div>

<div id="media-sidebar"><h3 style="color:var(--c-accent); border-bottom:1px solid var(--c-accent); padding-bottom:10px;">Gallery</h3><div id="sidebar-content"></div></div>
<div id="users-sidebar"><h3 style="color:var(--c-accent); border-bottom:1px solid var(--c-accent); padding-bottom:10px;">Users</h3><div id="users-list-content"></div></div>

<div id="feed"></div>

<div class="input-wrapper-outer">
    <div id="reply-bar"><span>Replying to <b id="reply-target-name">...</b></span> <i class="fa-solid fa-xmark" onclick="cancelReply()" style="cursor:pointer"></i></div>
    <div class="input-wrap">
        <div class="input-controls">
            <label style="cursor:pointer; color:var(--c-accent); font-size:20px;"><i class="fa-solid fa-paperclip"></i><input type="file" id="mediaInput" hidden></label>
            <input type="text" id="wizsInput" maxlength="400" placeholder="Message... (YouTube links auto-embed)" autocomplete="off">
        </div>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h3>Settings</h3>
        <input type="text" id="main-nick" maxlength="20" placeholder="Nickname">
        <select id="main-color">
             <option value="#00f2fe">Cyan</option> <option value="#e74c3c">Red</option> <option value="#2ecc71">Green</option>
             <option value="#f1c40f">Yellow</option> <option value="#ff6b81">Pink</option>
        </select>
        <select id="main-theme" onchange="applyTheme(this.value)">
            <option value="default">Default Dark</option> <option value="seashine">Sea Shine</option> 
            <option value="seaweed">Seaweed Fields</option> <option value="sandy">Sandy Oasis</option> 
            <option value="flame">Firelight</option> <option value="candy">Candyland</option>
            <option value="astrolight">Astrolight</option>
        </select>
        <label style="color:white; font-size:12px;">
            <input type="checkbox" id="main-bg-fx" checked onchange="toggleEffects()"> Enable BG Effects?
        </label>
        
        <div id="admin-controls" style="display:none; margin-top:15px; border-top:1px solid var(--c-accent); padding-top:10px;">
            <div style="font-weight:bold; color:var(--mint);">OWNER CONTROLS</div>
            <label style="color:#ccc; font-size:12px;"><input type="checkbox" id="rainbow-toggle"> üåà Admin Rainbow Messages</label>
            <button class="modal-btn" style="background:var(--red); font-size:10px; margin-top:10px;" onclick="triggerDestroy()">‚ö† MANUAL DESTROY</button>
            <div id="bannedUsersList" style="margin-top:10px;"></div>
        </div>

        <div id="userBlockListContainer" style="margin-top:10px; border-top:1px solid #444; padding-top:10px;"></div>
        <button class="modal-btn" onclick="saveMainSettings()">Save & Close</button>
    </div>
</div>

<div id="modModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--red)">Moderation Menu</h3>
        <p>Target: <span id="mod-target-name" style="color:var(--c-accent)">Unknown</span></p>
        
        <button class="modal-btn" style="background:var(--c-accent); color:black;" onclick="execNotify()">üì¢ NOTIFY USER</button>
        <div style="margin:10px 0; border-top:1px solid #444;"></div>
        
        <button class="modal-btn" style="background:var(--red); color:white;" onclick="execKick()">KICK USER</button>
        <button class="modal-btn" style="background:#ff9f43;" onclick="execBan(5)">Ban 5 Mins</button>
        <button class="modal-btn" style="background:#555;" onclick="document.getElementById('modModal').style.display='none'">Cancel</button>
    </div>
</div>

<script>
    const socket = io();
    let myName = "Wiz-" + Math.floor(Math.random()*999);
    let myColor = "#00f2fe";
    let myId = "";
    
    let isAdmin = false;
    let isAdminRainbow = false; 
    let currentTheme = 'default';
    let fxEnabled = true;
    let activeReply = null;
    let authTimer = null;
    let keysPressed = {};
    let isGHeld = false;
    let modTargetId = null;
    let modTargetName = null;
    
    let blockedIds = new Set();
    let discoveredUsers = {}; 
    let bannedUsers = {}; 

    // --- THEME ENGINE (VIVID COLOR MAPPING) ---
    const themes = {
        default: { dark: '#050505', panel: '#2a0a55', accent: '#00f2fe', input: '#1a0535' },
        seashine: { dark: '#001f24', panel: '#004d40', accent: '#00e5ff', input: '#00332e' },
        seaweed: { dark: '#004d40', panel: '#1b5e20', accent: '#69f0ae', input: '#0d3314' },
        sandy: { dark: '#2e2516', panel: '#d35400', accent: '#f39c12', input: '#5e2605' },
        flame: { dark: '#1a0505', panel: '#800000', accent: '#ff4500', input: '#3d0a0a' },
        candy: { dark: '#2e0b1f', panel: '#ff6b81', accent: '#ff9ff3', input: '#4a1230' },
        astrolight: { dark: '#150a26', panel: '#4b0082', accent: '#e056fd', input: '#240e45' }
    };

    const bgHTML = {
        default: "",
        seashine: `<div class="sea-gradient"></div><div class="wave-box"></div><div class="bubble" style="left:10%;"></div><div class="bubble" style="left:50%; animation-delay:2s;"></div>`,
        seaweed: `<div class="shallow-water-bg"></div><div class="strand" style="height:200px; left:5%;"></div><div class="strand" style="height:350px; left:20%; background:#1a5e4d; animation-duration:5s;"></div><div class="strand" style="height:250px; left:40%;"></div><div class="strand" style="height:400px; left:60%; background:#1a5e4d;"></div><div class="strand" style="height:300px; left:80%;"></div>`,
        sandy: `<div class="desert-bg"></div><div class="sun"></div><div class="dune"></div><div class="heat-haze"></div>`,
        flame: `<div class="fire-bg"></div><div class="fireplace-glow"></div><div class="ember" style="left:20%;"></div><div class="ember" style="left:60%; animation-delay:1s;"></div>`,
        candy: `<div class="candy-bg"></div><div class="falling-candy" style="left:10%;">üç¨</div><div class="falling-candy" style="left:60%; animation-delay:2s;">üç≠</div>`,
        astrolight: `<div class="space-bg"></div><div class="star" style="top:20%; left:20%;"></div><div class="star" style="top:50%; left:80%; animation-delay:1s;"></div>`
    };

    function applyTheme(t) {
        currentTheme = t;
        const p = themes[t] || themes.default;
        
        // Apply Variables
        document.documentElement.style.setProperty('--c-dark', p.dark);
        document.documentElement.style.setProperty('--c-panel', p.panel);
        document.documentElement.style.setProperty('--c-accent', p.accent);
        document.documentElement.style.setProperty('--c-input', p.input);
        
        // Apply Background
        const bg = document.getElementById('bg-container');
        if(fxEnabled && bgHTML[t]) {
            bg.innerHTML = bgHTML[t];
            document.body.style.background = "transparent";
        } else {
            bg.innerHTML = "";
            document.body.style.background = p.dark;
        }
    }
    
    function toggleEffects() { applyTheme(currentTheme); }

    // --- SECURITY & OWNER ---
    document.addEventListener('keydown', (e) => {
        keysPressed[e.key.toLowerCase()] = true;
        if (e.key.toLowerCase() === 'g') isGHeld = true;
        if(keysPressed['q'] && keysPressed['1'] && myName === "Founder1" && !isAdmin) {
            if(!authTimer) authTimer = setTimeout(() => {
                isAdmin = true;
                isAdminRainbow = true;
                document.getElementById('verified-toast').style.display = 'flex';
                setTimeout(() => document.getElementById('verified-toast').style.display = 'none', 3000);
                document.getElementById('wizsInput').classList.add('owner-input-glow'); // ACTIVE RAINBOW INPUT
                authTimer = null;
            }, 3000);
        }
    });
    document.addEventListener('keyup', (e) => {
        keysPressed[e.key.toLowerCase()] = false;
        if (e.key.toLowerCase() === 'g') isGHeld = false;
        if(authTimer) clearTimeout(authTimer);
    });

    // --- MODERATION ---
    function openModMenu(id, name) {
        modTargetId = id; modTargetName = name;
        document.getElementById('mod-target-name').innerText = name;
        document.getElementById('modModal').style.display = 'flex';
    }

    function execNotify() {
        const msg = prompt("Enter Notification Message (Alert):");
        if(msg && modTargetId) {
            sendMsg(`CMD:NOTIFY:${modTargetId}:${msg}`, null, null, true);
            document.getElementById('modModal').style.display = 'none';
        }
    }
    
    function execKick() { sendMsg("CMD:KICK:"+modTargetId, null, null, true); document.getElementById('modModal').style.display = 'none'; }
    function execBan(m) { 
        const u = Date.now() + (m*60000); 
        bannedUsers[modTargetId] = { name: modTargetName, until: u };
        sendMsg(`CMD:BAN:${modTargetId}:${u}`, null, null, true); 
        document.getElementById('modModal').style.display = 'none'; 
    }
    function triggerDestroy() { if(confirm("CRASH ROOM?")) sendMsg("CMD:DESTROY", null, null, true); }

    // --- CORE LOGIC ---
    socket.on('connect', () => myId = socket.id);
    
    window.onload = () => {
        setTimeout(() => {
            document.getElementById('introLogo').classList.add('minimize');
            setTimeout(() => {
                document.getElementById('status-bar').style.opacity = '1';
                document.getElementById('tutorial-card').style.display = 'block';
            }, 800);
        }, 1000);
    };

    function nextStep(s) { document.querySelectorAll('.tut-step').forEach(e=>e.classList.remove('active')); document.getElementById('step'+s).classList.add('active'); }
    function endTutorial() { document.getElementById('intro-overlay').style.display = 'none'; }
    
    function syncSettings() {
        myName = document.getElementById('tut-nick').value || myName;
        myColor = document.getElementById('tut-color').value;
        fxEnabled = document.getElementById('tut-bg-fx').checked;
        toggleEffects();
        renderUserList();
    }
    
    function openMainSettings() {
        document.getElementById('main-nick').value = myName;
        document.getElementById('main-color').value = myColor;
        document.getElementById('main-theme').value = currentTheme;
        document.getElementById('main-bg-fx').checked = fxEnabled;
        if(isAdmin) {
            document.getElementById('admin-controls').style.display = "block";
            document.getElementById('rainbow-toggle').checked = isAdminRainbow;
            renderBanned();
        }
        renderBlocks();
        document.getElementById('settingsModal').style.display = 'flex';
    }

    function saveMainSettings() {
        myName = document.getElementById('main-nick').value || myName;
        if(myName !== "Founder1") { isAdmin = false; document.getElementById('wizsInput').classList.remove('owner-input-glow'); }
        myColor = document.getElementById('main-color').value;
        fxEnabled = document.getElementById('main-bg-fx').checked;
        if(isAdmin) isAdminRainbow = document.getElementById('rainbow-toggle').checked;
        toggleEffects();
        renderUserList();
        document.getElementById('settingsModal').style.display = 'none';
    }

    // --- MESSAGING ---
    function sendMsg(text, media=null, type=null, isCmd=false) {
        if((!text && !media) || (!isCmd && text.length > 400)) return;
        const pl = { name: myName, color: myColor, text: text, msgId: 'm-'+Date.now(), reply: activeReply, rainbowMode: isAdminRainbow, isCmd: isCmd };
        if(media) pl[type] = media;
        socket.emit('send-msg', pl);
        if(!isCmd) document.getElementById('wizsInput').value = '';
        cancelReply();
    }

    socket.on('receive-msg', data => {
        if(data.isCmd) {
            const parts = data.text.split(':');
            const cmd = parts[1];
            
            // COMMANDS
            if(cmd === "DESTROY") {
                document.querySelectorAll('div').forEach(el => el.classList.add('destroy-anim'));
                setTimeout(() => document.getElementById('destroyed-msg').style.display = 'block', 2000);
            }
            if(cmd === "KICK" && parts[2] === myId) {
                document.getElementById('kick-overlay').style.display = 'flex';
                setTimeout(()=>window.location.reload(), 2000);
            }
            if(cmd === "BAN" && parts[2] === myId) {
                const u = parseInt(parts[3]);
                localStorage.setItem('wizBanEnd', u);
                enforceBanUI(Math.ceil((u - Date.now())/60000));
            }
            if(cmd === "NOTIFY" && parts[2] === myId) {
                // PARTS[3] might be cut if msg had colons, join rest
                const msg = parts.slice(3).join(':');
                document.getElementById('notify-content').innerText = msg;
                document.getElementById('notify-overlay').style.display = 'flex';
            }
            return;
        }

        if(blockedIds.has(data.userId)) return;
        if(data.userId && data.name) { discoveredUsers[data.userId] = {name: data.name, color: data.color}; renderUserList(); }

        const div = document.createElement('div');
        div.className = 'msg';
        div.style.setProperty('--u-color', data.color);
        div.onclick = (e) => {
            if(isGHeld && isAdmin) { e.preventDefault(); openModMenu(data.userId, data.name); return; }
            if(e.target.tagName!=='IMG' && e.target.tagName!=='VIDEO') {
                activeReply = {id: data.msgId, name: data.name, text: data.text || 'Media'};
                document.getElementById('reply-bar').style.display = 'flex';
                document.getElementById('reply-target-name').innerText = data.name;
            }
        };

        if(data.name === "WIZs Owner" || (data.rainbowMode && data.name==="Founder1")) {
            div.classList.add('rainbow-box');
            div.innerHTML += `<div class="owner-name" style="font-weight:bold">${data.name}</div>`;
        } else {
            div.innerHTML += `<div style="font-weight:bold; color:${data.color}">${data.name}</div>`;
        }

        if(data.reply) div.innerHTML = `<div style="font-size:11px; color:#aaa; border-left:2px solid #555; padding-left:5px; margin-bottom:5px;">Replying to ${data.reply.name}</div>` + div.innerHTML;
        
        let content = data.text || '';
        if(data.text && data.text.includes('youtube.com')) {
            const vid = data.text.split('v=')[1]?.split('&')[0];
            if(vid) { 
                content += `<iframe width="100%" height="250" src="https://www.youtube.com/embed/${vid}" frameborder="0" style="margin-top:10px; border-radius:8px;"></iframe>`;
                addToSidebar(`https://img.youtube.com/vi/${vid}/hqdefault.jpg`, `https://www.youtube.com/watch?v=${vid}`, true);
            }
        }
        if(data.image) { content += `<img src="${data.image}" class="media-msg" onclick="this.classList.toggle('unblurred')">`; addToSidebar(data.image, null, false); }
        if(data.video) { content += `<video src="${data.video}" class="media-msg" onclick="this.classList.toggle('unblurred')" loop muted></video>`; addToSidebar(null, null, false); }

        div.innerHTML += `<div style="margin-top:5px;">${content}</div>`;
        document.getElementById('feed').appendChild(div);
        window.scrollTo(0, document.body.scrollHeight);
    });

    // --- HELPERS ---
    function addToSidebar(src, link, yt) {
        if(!src) return;
        const i = document.createElement('img'); i.className = 'sidebar-thumb'; i.src = src;
        i.onclick = yt ? ()=>window.open(link) : ()=>{};
        document.getElementById('sidebar-content').prepend(i);
    }
    
    function renderUserList() {
        const l = document.getElementById('users-list-content'); l.innerHTML = '';
        Object.keys(discoveredUsers).forEach(u => {
            if(u === myId) return;
            l.innerHTML += `<div class="user-row"><span class="user-dot" style="background:${discoveredUsers[u].color}"></span> ${discoveredUsers[u].name}</div>`;
        });
    }

    function renderBlocks() {
        const l = document.getElementById('userBlockListContainer'); l.innerHTML = '';
        Object.keys(discoveredUsers).forEach(uid => {
            if(uid === myId) return;
            const b = blockedIds.has(uid);
            const d = document.createElement('div');
            d.style.cssText = "padding:8px; display:flex; justify-content:space-between; color:white; font-size:12px; cursor:pointer;";
            d.innerHTML = `<span>${discoveredUsers[uid].name}</span> <span style="color:${b?'red':'#888'}">${b?'Unblock':'Block'}</span>`;
            d.onclick = () => { if(b) blockedIds.delete(uid); else blockedIds.add(uid); renderBlocks(); };
            l.appendChild(d);
        });
    }

    function renderBanned() {
        const l = document.getElementById('bannedUsersList'); l.innerHTML = '';
        Object.keys(bannedUsers).forEach(uid => {
             l.innerHTML += `<div style="color:var(--red); font-size:11px; cursor:pointer;" onclick="sendMsg('CMD:UNBAN:${uid}', null, null, true); delete bannedUsers['${uid}']; renderBanned();">UNBAN ${bannedUsers[uid].name}</div>`;
        });
    }

    function enforceBanUI(m) {
        document.getElementById('ban-overlay').style.display = 'flex';
        document.getElementById('ban-timer-display').innerText = m;
        document.getElementById('wizsInput').disabled = true;
        const i = setInterval(() => {
            const left = Math.ceil((parseInt(localStorage.getItem('wizBanEnd')) - Date.now())/60000);
            document.getElementById('ban-timer-display').innerText = left;
            if(left <= 0) { localStorage.removeItem('wizBanEnd'); document.getElementById('ban-overlay').style.display='none'; document.getElementById('wizsInput').disabled=false; clearInterval(i); }
        }, 30000);
    }

    function cancelReply() { activeReply = null; document.getElementById('reply-bar').style.display = 'none'; }
    document.getElementById('wizsInput').onkeydown = e => { if(e.key==='Enter') sendMsg(e.target.value); };
    document.getElementById('mediaInput').onchange = e => { const r=new FileReader(); r.onload=()=>sendMsg("",r.result,e.target.files[0].type.includes('video')?'video':'image'); r.readAsDataURL(e.target.files[0]); };
    
    socket.on('user-count', c => document.getElementById('count-display').innerText = c + " Online");
    socket.on('timer-update', s => {
        document.getElementById('reset-timer-real').innerText = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        if(s<=0 && !localStorage.getItem('wizBanEnd')) { document.getElementById('lockdown-overlay').style.display = 'flex'; document.getElementById('wizsInput').disabled=true; }
    });
</script>
</body>
</html>
