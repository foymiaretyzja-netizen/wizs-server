<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --font-main: 'Roboto Mono', monospace;
            --c-dark: #0a0a0a;
            --c-panel: rgba(20, 20, 20, 0.7);
            --c-accent: #00ffcc; /* Default Mint */
            --c-accent-dim: rgba(0, 255, 204, 0.2);
            --grad-mint: linear-gradient(180deg, #00ffcc 0%, #008f7a 100%);
        }

        /* --- THEME DEFINITIONS --- */
        body.theme-default { --c-bg: #050505; --c-accent: #00ffcc; --bg-anim: stars; }
        body.theme-fire { --c-bg: #1a0500; --c-accent: #ff4500; --c-panel: rgba(50, 10, 0, 0.7); }
        body.theme-sea { --c-bg: #001f24; --c-accent: #00e5ff; --c-panel: rgba(0, 40, 50, 0.7); }
        body.theme-astro { --c-bg: #120024; --c-accent: #d845ff; --c-panel: rgba(30, 0, 50, 0.7); }

        * { box-sizing: border-box; font-family: var(--font-main); transition: all 0.3s ease; }
        
        body {
            margin: 0; background: var(--c-bg); color: #fff;
            overflow: hidden; height: 100vh; width: 100vw;
        }

        /* --- BACKGROUND FX --- */
        #bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        
        /* Stars (Default) */
        .fx-stars { background: radial-gradient(white 1px, transparent 1px) 0 0 / 50px 50px; opacity: 0.3; }
        
        /* Fire (Lava) */
        .fx-fire { background: linear-gradient(to top, #300, transparent); }
        .ember { position: absolute; width: 4px; height: 4px; background: orange; animation: floatUp 4s infinite linear; border-radius: 50%; bottom: -10px; }
        
        /* Sea (Waves) */
        .fx-sea { background: linear-gradient(180deg, rgba(0,255,255,0.1), transparent); }
        .weed { position: absolute; bottom: 0; width: 10px; height: 100px; background: rgba(0,255,200,0.3); border-radius: 20px 20px 0 0; animation: sway 3s infinite ease-in-out alternate; }

        @keyframes floatUp { to { transform: translateY(-100vh); opacity: 0; } }
        @keyframes sway { from { transform: rotate(-5deg); } to { transform: rotate(5deg); } }

        /* --- INTRO SEQUENCE --- */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .nexus-logo {
            font-size: 4rem; font-weight: 700;
            background: var(--grad-mint); -webkit-background-clip: text; color: transparent;
            opacity: 0; animation: fadePulse 2s forwards; text-shadow: 0 0 30px var(--c-accent);
        }
        @keyframes fadePulse {
            0% { opacity: 0; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: var(--c-panel); backdrop-filter: blur(10px);
            border: 1px solid var(--c-accent-dim); box-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }

        /* TOP BAR */
        #top-bar {
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid var(--c-accent); position: relative; z-index: 10;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #333; margin-right: 5px; box-shadow: 0 0 5px currentColor;}
        .status-dot.green { background: #00ff00; color: #00ff00; }
        .status-dot.red { background: #ff0000; color: #ff0000; }

        /* CHAT AREA */
        #chat-container {
            height: calc(100% - 130px); overflow-y: auto; padding: 20px;
            scroll-behavior: smooth;
        }
        
        /* MESSAGES */
        .msg {
            margin-bottom: 15px; display: flex; flex-direction: column; animation: slideUp 0.3s ease;
            max-width: 800px;
        }
        .msg.me { align-items: flex-end; margin-left: auto; }
        .msg-header { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; margin-bottom: 5px; }
        .msg-pfp { width: 30px; height: 30px; border-radius: 5px; object-fit: cover; background: #333; }
        .msg-content {
            background: rgba(255,255,255,0.05); padding: 12px 18px; border-radius: 8px;
            border-left: 3px solid var(--user-color, #fff); position: relative;
        }
        .msg-timestamp { font-size: 0.7rem; color: #888; margin-top: 5px; text-align: right; }
        
        .msg-media {
            max-width: 300px; max-height: 200px; border-radius: 8px; cursor: pointer;
            filter: blur(15px); transition: filter 0.3s;
        }
        .msg-media.unblurred { filter: blur(0); }

        /* REPLY & ACTIONS */
        .reply-context {
            font-size: 0.75rem; color: var(--c-accent); padding: 5px;
            border-left: 2px solid var(--c-accent); margin-bottom: 5px; opacity: 0.8;
        }
        .action-menu {
            position: absolute; background: var(--c-dark); border: 1px solid var(--c-accent);
            padding: 5px; display: none; z-index: 100; font-size: 0.8rem;
        }
        .action-item { padding: 5px 10px; cursor: pointer; }
        .action-item:hover { background: var(--c-accent); color: #000; }

        /* INPUT AREA */
        #input-area {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            padding: 10px 20px; display: flex; gap: 10px; align-items: center; z-index: 20;
        }
        #typing-indicator {
            position: absolute; top: -25px; left: 20px; font-size: 0.8rem; color: var(--c-accent);
            opacity: 0; transition: opacity 0.3s;
        }
        #msg-input {
            flex-grow: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--c-accent-dim);
            color: #fff; padding: 12px; border-radius: 4px; outline: none;
        }
        #msg-input:focus { border-color: var(--c-accent); box-shadow: 0 0 10px var(--c-accent-dim); }
        .btn-icon {
            background: none; border: 1px solid var(--c-accent-dim); color: var(--c-accent);
            width: 45px; height: 45px; border-radius: 4px; cursor: pointer; display: grid; place-items: center;
        }
        .btn-icon:hover { background: var(--c-accent); color: #000; }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 5000;
        }
        .modal-box {
            width: 90%; max-width: 500px; padding: 30px; text-align: center;
            border: 1px solid var(--c-accent);
        }
        
        .pfp-preview { width: 80px; height: 80px; border: 2px solid var(--c-accent); border-radius: 10px; margin: 10px auto; display: grid; place-items: center; overflow: hidden; }
        
        select, input[type="text"] {
            width: 100%; padding: 10px; margin: 10px 0; background: #222; border: 1px solid #444; color: white;
        }

        /* MEDIA SIDEBAR */
        #media-sidebar {
            position: fixed; top: 60px; right: -320px; width: 300px; height: calc(100% - 60px);
            transition: right 0.4s; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; z-index: 100;
        }
        #media-sidebar.open { right: 0; }
        .sidebar-item { width: 100%; aspect-ratio: 1; object-fit: cover; border: 1px solid #555; }

        /* KEYFRAMES */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* NOTIFICATION TOAST */
        #toast {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; background: var(--c-accent); color: #000;
            font-weight: bold; border-radius: 20px; opacity: 0; pointer-events: none;
        }
        
        /* SPAM DISABLED */
        .disabled-input { opacity: 0.5; pointer-events: none; }
        
        /* MENTION LIST */
        #mention-list {
            position: absolute; bottom: 70px; left: 70px; background: #111; border: 1px solid var(--c-accent);
            display: none; flex-direction: column; width: 200px;
        }
        .mention-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #333; }
        .mention-item:hover { background: #333; }
    </style>
</head>
<body class="theme-default">

    <div id="bg-layer" class="fx-stars"></div>

    <div id="intro-screen">
        <div class="nexus-logo">&lt;NEXUS&gt;</div>
    </div>

    <div id="setup-modal" class="modal-overlay glass-panel">
        <div class="modal-box glass-panel">
            <h2 style="color:var(--c-accent)">INITIALIZE PROFILE</h2>
            <div class="pfp-preview" onclick="document.getElementById('pfp-upload').click()">
                <img id="pfp-display" src="" style="width:100%; height:100%; display:none; object-fit:cover;">
                <span id="pfp-placeholder" style="font-size:40px;">?</span>
            </div>
            <input type="file" id="pfp-upload" hidden accept="image/*">
            <input type="text" id="username-in" placeholder="Identify Yourself" maxlength="15">
            
            <label>Color Signature</label>
            <select id="color-in">
                <option value="linear-gradient(to bottom, #ff5f6d, #ffc371)">Sunset (Orange/Yellow)</option>
                <option value="linear-gradient(to bottom, #00c6ff, #0072ff)">Deep Ocean (Blue)</option>
                <option value="linear-gradient(to bottom, #11998e, #38ef7d)" selected>Mint (Green)</option>
                <option value="linear-gradient(to bottom, #833ab4, #fd1d1d)">Heat (Purple/Red)</option>
                <option value="#ffffff">Ghost (White)</option>
            </select>

            <label>Environment</label>
            <select id="theme-in">
                <option value="theme-default">Default (Stars)</option>
                <option value="theme-fire">FireStone (Volcano)</option>
                <option value="theme-sea">SeaShine (Ocean)</option>
                <option value="theme-astro">AstroLight (Space)</option>
            </select>

            <button class="btn-icon" style="width:100%; margin-top:20px; font-weight:bold;" onclick="completeSetup()">ENTER NEXUS</button>
            <p style="font-size:0.7rem; color:#888; margin-top:10px;">Data wipes every 15 minutes.</p>
        </div>
    </div>

    <div id="main-ui" style="display:none; height:100%;">
        
        <div id="top-bar" class="glass-panel">
            <div style="display:flex; align-items:center;">
                <div class="nexus-logo" style="font-size:1.5rem; margin-right:20px; animation:none;">NEXUS</div>
                <div class="status-dot green" id="conn-status"></div>
                <span id="user-count" style="font-size:0.8rem;">0 Online</span>
            </div>
            <div style="font-size:0.8rem; color:var(--c-accent);">WIPE IN: <span id="wipe-timer">15:00</span></div>
            <div>
                <i class="fa-solid fa-photo-film btn-icon" style="width:30px; height:30px; font-size:14px;" onclick="toggleMediaSidebar()"></i>
            </div>
        </div>

        <div id="chat-container">
            <div id="empty-state" style="text-align:center; margin-top:50px; opacity:0.5;">
                <h3>SIGNAL SILENT</h3>
                <p>No other signals detected. Share the link?</p>
            </div>
        </div>

        <div id="input-area" class="glass-panel">
            <div id="typing-indicator">Someone is typing...</div>
            
            <div id="reply-bar" style="display:none; position:absolute; top:-40px; left:0; width:100%; background:var(--c-dark); padding:10px; border-top:1px solid var(--c-accent); font-size:0.8rem;">
                Replying to <span id="reply-target-name">...</span> <i class="fa fa-times" style="float:right; cursor:pointer;" onclick="cancelReply()"></i>
            </div>
            
            <div id="mention-list"></div>

            <label class="btn-icon">
                <i class="fa-solid fa-paperclip"></i>
                <input type="file" id="media-upload" hidden accept="image/*,video/*">
            </label>
            
            <input type="text" id="msg-input" placeholder="Transmit..." autocomplete="off">
        </div>
    </div>

    <div id="media-sidebar" class="glass-panel"></div>

    <div id="toast">ALERT</div>

    <div id="ctx-menu" class="action-menu">
        <div class="action-item" onclick="handleReply()">Reply</div>
        <div class="action-item" onclick="handleVoteKick()">Vote Kick (Report)</div>
        <div class="action-item" style="color:#aaa" onclick="closeCtx()">Cancel</div>
    </div>

    <script>
        const socket = io();
        let myProfile = { name: "Anon", color: "#fff", pfp: null };
        let activeReplyId = null;
        let activeCtxTarget = null; // {id, name}
        let spamCount = 0;
        let lastMsgTime = 0;
        let knownUsers = {};

        // --- SETUP ---
        setTimeout(() => {
            document.getElementById('intro-screen').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('intro-screen').style.display = 'none';
                document.getElementById('setup-modal').style.display = 'flex';
            }, 1000);
        }, 2500);

        // PFP PREVIEW
        document.getElementById('pfp-upload').addEventListener('change', function() {
            const reader = new FileReader();
            reader.onload = function(e) {
                myProfile.pfp = e.target.result;
                document.getElementById('pfp-display').src = e.target.result;
                document.getElementById('pfp-display').style.display = 'block';
                document.getElementById('pfp-placeholder').style.display = 'none';
            }
            reader.readAsDataURL(this.files[0]);
        });

        function completeSetup() {
            const name = document.getElementById('username-in').value || "User-" + Math.floor(Math.random()*1000);
            myProfile.name = name;
            myProfile.color = document.getElementById('color-in').value;
            const theme = document.getElementById('theme-in').value;

            // Apply Theme
            document.body.className = theme;
            const bg = document.getElementById('bg-layer');
            bg.innerHTML = ''; // Clear old fx
            bg.className = '';
            
            if(theme === 'theme-fire') {
                bg.className = 'fx-fire';
                for(let i=0; i<10; i++) {
                    let d = document.createElement('div'); d.className='ember';
                    d.style.left = Math.random()*100 + '%'; d.style.animationDelay = Math.random()*2+'s';
                    bg.appendChild(d);
                }
            } else if (theme === 'theme-sea') {
                bg.className = 'fx-sea';
                for(let i=0; i<5; i++) {
                    let w = document.createElement('div'); w.className='weed';
                    w.style.left = (i*20) + '%'; w.style.height = (100 + Math.random()*100) + 'px';
                    bg.appendChild(w);
                }
            } else {
                bg.className = 'fx-stars';
            }

            socket.emit('set-profile', myProfile);
            document.getElementById('setup-modal').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';
        }

        // --- MESSAGING ---
        const input = document.getElementById('msg-input');
        
        input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') sendMessage();
            socket.emit('typing', true);
            clearTimeout(window.typingTimer);
            window.typingTimer = setTimeout(() => socket.emit('typing', false), 1000);
        });
        
        // MENTIONS
        input.addEventListener('input', (e) => {
            const val = input.value;
            const mentionList = document.getElementById('mention-list');
            
            if(val.includes('@')) {
                const query = val.split('@').pop().toLowerCase();
                mentionList.style.display = 'flex';
                mentionList.innerHTML = '';
                Object.values(knownUsers).forEach(u => {
                    if(u.name.toLowerCase().includes(query)) {
                        let d = document.createElement('div'); d.className = 'mention-item';
                        d.innerText = u.name;
                        d.onclick = () => { 
                            input.value = input.value.replace(`@${query}`, `@${u.name} `);
                            mentionList.style.display='none';
                        };
                        mentionList.appendChild(d);
                    }
                });
            } else {
                mentionList.style.display = 'none';
            }
        });

        // MEDIA UPLOAD
        document.getElementById('media-upload').addEventListener('change', function() {
            if(checkSpam()) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                socket.emit('send-message', { text: "", media: { type: 'image', src: e.target.result } });
                showToast("Transmitting Media...");
            };
            reader.readAsDataURL(this.files[0]);
            this.value = '';
        });

        function sendMessage() {
            const text = input.value.trim();
            if(!text) return;
            if(checkSpam()) return;

            socket.emit('send-message', { text: text, replyTo: activeReplyId });
            input.value = '';
            cancelReply();
        }

        function checkSpam() {
            const now = Date.now();
            if (now - lastMsgTime < 1000) spamCount++;
            else spamCount = 0;
            lastMsgTime = now;

            if (spamCount > 6) {
                showToast("ANTISPAM: COOLDOWN 10s");
                input.disabled = true;
                input.classList.add('disabled-input');
                setTimeout(() => {
                    input.disabled = false;
                    input.classList.remove('disabled-input');
                    spamCount = 0;
                }, 10000);
                return true;
            }
            return false;
        }

        // --- INCOMING SOCKET EVENTS ---
        socket.on('user-count', c => {
            document.getElementById('user-count').innerText = c + " Online";
            if(c > 1) document.getElementById('empty-state').style.display = 'none';
        });

        socket.on('user-list', list => knownUsers = list);

        socket.on('new-message', msg => {
            const div = document.createElement('div');
            div.className = `msg ${msg.userId === socket.id ? 'me' : ''}`;
            div.id = `msg-${msg.id}`;
            div.style.setProperty('--user-color', msg.color.includes('gradient') ? '#fff' : msg.color);
            
            // Highlight mention
            if(msg.text.includes(`@${myProfile.name}`)) {
                div.style.border = "1px solid var(--c-accent)";
                showToast(`New mention from ${msg.name}`);
            }

            // Click for Context Menu
            div.onclick = (e) => {
                if(msg.userId === socket.id) return; // Can't report self
                e.stopPropagation();
                activeCtxTarget = msg;
                const menu = document.getElementById('ctx-menu');
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
            };

            let contentHtml = '';
            
            // Reply Header
            if(msg.replyTo) {
                const rName = document.getElementById(`msg-${msg.replyTo}`)?.querySelector('.name-tag')?.innerText || "Someone";
                contentHtml += `<div class="reply-context" onclick="scrollToMsg('${msg.replyTo}')">Replying to ${rName}</div>`;
            }

            // Media
            if(msg.media) {
                contentHtml += `<img src="${msg.media.src}" class="msg-media" onclick="this.classList.toggle('unblurred')">`;
                addToMediaSidebar(msg.media.src);
            }

            // Text & YT
            if(msg.text) {
                let txt = msg.text;
                // Simple YT Embed
                const ytMatch = txt.match(/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/);
                if(ytMatch) {
                    txt += `<br><iframe width="100%" height="200" src="https://www.youtube.com/embed/${ytMatch[1]}" frameborder="0" style="margin-top:10px;"></iframe>`;
                }
                contentHtml += `<div>${txt}</div>`;
            }

            // Structure
            div.innerHTML = `
                <div class="msg-header">
                    <img class="msg-pfp" src="${msg.pfp || ''}" onerror="this.style.display='none'">
                    <span class="name-tag" style="background:${msg.color}; -webkit-background-clip:text; color:transparent; font-weight:bold;">${msg.name}</span>
                </div>
                <div class="msg-content" style="background:${msg.color.includes('gradient')?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.5)'}">
                    ${contentHtml}
                    <div class="msg-timestamp" data-ts="${msg.timestamp}">Just now</div>
                </div>
            `;

            document.getElementById('chat-container').appendChild(div);
            div.scrollIntoView();
        });

        socket.on('user-typing', data => {
            const ind = document.getElementById('typing-indicator');
            ind.innerText = data.isTyping ? `${data.user} is typing...` : '';
            ind.style.opacity = data.isTyping ? 1 : 0;
        });

        socket.on('timer-update', ms => {
            const mins = Math.floor(ms / 60000);
            const secs = Math.floor((ms % 60000) / 1000);
            document.getElementById('wipe-timer').innerText = `${mins}:${secs < 10 ? '0'+secs : secs}`;
        });

        socket.on('system-wipe', () => {
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('media-sidebar').innerHTML = '';
            showToast("SYSTEM WIPE COMPLETE");
            window.location.reload(); // Force re-entry
        });

        socket.on('force-kick', () => {
            document.body.innerHTML = `<div style="display:flex; height:100vh; align-items:center; justify-content:center; background:black; color:red; flex-direction:column;">
                <h1>CONNECTION TERMINATED</h1>
                <p>The community has removed you.</p>
            </div>`;
            socket.disconnect();
        });

        socket.on('system-alert', data => showToast(data.text));

        // --- UTILS ---
        function showToast(txt) {
            const t = document.getElementById('toast');
            t.innerText = txt;
            t.style.opacity = 1;
            t.style.top = '100px';
            setTimeout(() => { t.style.opacity = 0; t.style.top = '80px'; }, 3000);
        }

        // Close Ctx Menu on click elsewhere
        window.onclick = () => document.getElementById('ctx-menu').style.display = 'none';

        function handleReply() {
            if(!activeCtxTarget) return;
            activeReplyId = activeCtxTarget.id;
            document.getElementById('reply-bar').style.display = 'block';
            document.getElementById('reply-target-name').innerText = activeCtxTarget.name;
            input.focus();
        }

        function cancelReply() {
            activeReplyId = null;
            document.getElementById('reply-bar').style.display = 'none';
        }

        function handleVoteKick() {
            if(!activeCtxTarget) return;
            if(confirm(`Initiate VOTE KICK against ${activeCtxTarget.name}?`)) {
                socket.emit('vote-kick', activeCtxTarget.userId);
            }
        }

        function toggleMediaSidebar() {
            document.getElementById('media-sidebar').classList.toggle('open');
        }

        function addToMediaSidebar(src) {
            const img = document.createElement('img');
            img.src = src;
            img.className = 'sidebar-item';
            img.onclick = () => window.open(src);
            document.getElementById('media-sidebar').prepend(img);
        }

        function scrollToMsg(id) {
            const el = document.getElementById(`msg-${id}`);
            if(el) {
                el.scrollIntoView({behavior:'smooth'});
                el.style.transform = 'scale(1.02)';
                setTimeout(()=>el.style.transform='scale(1)', 500);
            } else {
                showToast("Message expired or lost.");
            }
        }

        // Timestamps updater
        setInterval(() => {
            document.querySelectorAll('.msg-timestamp').forEach(el => {
                const ts = parseInt(el.getAttribute('data-ts'));
                const diff = Math.floor((Date.now() - ts) / 1000);
                if(diff < 60) el.innerText = "Just now";
                else if(diff < 180) el.innerText = "A few mins ago";
                else el.innerText = "A while ago";
            });
        }, 60000);

    </script>
</body>
</html>
</html>
